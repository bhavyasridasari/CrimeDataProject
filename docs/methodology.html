<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Methodology and Visualizations – STAT Final Project</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">STAT Final Project</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./introduction.html"> 
<span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./research_questions.html"> 
<span class="menu-text">Research Questions</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./methodology.html" aria-current="page"> 
<span class="menu-text">Methodology &amp; Visualizations</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./conclusion.html"> 
<span class="menu-text">Conclusion</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./code.html"> 
<span class="menu-text">Source Code</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./references.html"> 
<span class="menu-text">References</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About Us</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Methodology and Visualizations</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>I Dataset.</strong></p>
<p>The dataset that we selected is called “crime data from 2020 to present”. It provides detailed information on reported crime incidents within the City of Los Angeles since 2020. This dataset is a valuable resource for understanding crime trends, geographic distribution, and incident specifics, and it is regularly updated to ensure current data availability. It has variables such as area, area name, victim age, victim sex, type of crime committed, etc. Out of those we have categorical variables like crime, crime type, victim related information (demographics), numerical data such as geographic coordinates, incident counts and identifiers, and many more. The total number of rows is 986873 and the number of columns is 28, after cleaning we get 304200 rows and 18 columns. This dataset is primarily aimed at public access and research, enabling analysts, policymakers, and the community to study crime patterns and develop data-driven strategies for crime reduction. It is freely available for download on the U.S. government’s open data portal, data.gov, and is maintained by the Los Angeles city authorities. It aligns with efforts to promote transparency and accountability through open data initiatives.</p>
<p>Data Cleaning:</p>
<p>The data cleaning process was initiated with an inspection of the dataset to understand its structure and quality. Key functions such as head(), summary(), nrow(), and ncol() were used to explore the dataset and assess its dimensions and attributes. Column names were retrieved to identify unnecessary or irrelevant fields for removal.</p>
<p>Subsequently, a series of irrelevant columns, including DR_NO, AREA, TIME.OCC, Part.1.2, Mocodes, Status, Crm.Cd.2, Crm.Cd.3, Crm.Cd.4, and Cross.Street, were excluded from the dataset. These columns were deemed redundant or unrelated to the intended analysis. The dataset was further refined by handling missing values, ensuring completeness. Rows with missing values were identified and removed using the na.omit() function to maintain analytical integrity.</p>
<p>To address redundancy, duplicate rows were identified and eliminated using the distinct() function. Date fields, such as Date.Rptd and DATE.OCC, were standardized using a custom convert_dates function. This conversion ensured uniformity in date formats, critical for subsequent analysis. Additional validation confirmed the successful transformation of these date columns.</p>
<p>Invalid data entries were also addressed. Negative values in the Vict.Age column, which were logically incorrect, were replaced with NA. Similarly, zero values in the LAT and LON columns, indicative of invalid geographical coordinates, were also replaced with NA.</p>
<p>Finally, the cleaned dataset was saved as Cleaned_Crime_Data.csv, ensuring it is ready for further analysis. This cleaning process has improved the dataset’s quality, consistency, and relevance, enabling a robust foundation for meaningful analysis and insights.</p>
<p><strong>II Methodology.</strong></p>
<p>After data cleaning, we analyzed and visualized to explore and learn more about the dataset. In the start we performed summary statistics on the cleaned data.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-124261092.png" class="img-fluid figure-img"></p>
<figcaption>Fig 1</figcaption>
</figure>
</div>
<p>Fig 1. Displays a summary of a crime dataset consisting of 304200 records and 18 attributes. Key columns include Date.Rptd and Date.OCC, both recorded as character types, indicating the reporting and occurrence dates of crimes. Geographical information includes LAT and LON for latitude and longitude, with ranges suggesting broad geographical coverage. Vict.Sex, Vict.Descent, and Vict.Age capture victim demographics. Crime characteristics are detailed by columns such as Cr,.Cd (which is numeric) and Crm.Cd.Desc ( which is descriptive), with associated variables like Premis.Cd and Weapon.Used.Cd, indicating the premise type and weapon usage. The dataset includes additional descriptors like Status.Desc and AREA.NAME.</p>
<p><img src="images/clipboard-1075185314.png" class="img-fluid"></p>
<p>Fig 2</p>
<p>Then to see which area has more amount of crimes we calculated that. &nbsp;(see Fig 2)</p>
<p><img src="images/clipboard-1734224926.png" class="img-fluid"></p>
<p>Fig 3</p>
<p>The scatter plot(Fig 3) visualizes the relationship between victim age, gender and the total number of crimes. The data includes realistic victim ages and is categorized by sex. Key observations show that the highest crime counts occur in victims aged 20-35, with males being the most frequently victimized group, followed by females. The trend decreases steadily beyond 35 years, with very few crimes involving victims older than 75. The category “X- non binary” has consistently low crime counts across all ages, suggesting it may represent an unspecified or less common gender classification. The distribution highlights the significant vulnerability of younger adults, particularly males, to criminal activities and the importance of targeted interventions for this demographic.</p>
<p><img src="images/clipboard-262744825.png" class="img-fluid"></p>
<p>Fig 4</p>
<p>Fig 4 Shows the frequency distribution of crimes across different premise types. Crimes occurring on streets account for the largest proportion, indicating that public spaces represent a significant area of concern for criminal activity. Single-family dwellings and multi-unit dwellings show high crime rates, suggesting residential areas are vulnerable. Sidewalks represent another significant category. In contrast, crimes reported in locations such as alleys, parking lots and parks/play grounds constitute a considerably smaller percentage of total crimes.</p>
<p><img src="images/clipboard-3667294651.png" class="img-fluid"></p>
<p>FIg 5</p>
<p>The above diagram displays the frequency distribution (Fig 5.) distribution of victim ages for five crime categories: Assault with Deadly Weapon/Aggravated Assault, Battery-simple Assault, Criminal Threats – no weapon displayed, intimate partner simple assault, and robbery. &nbsp;The distribution of victim ages shows that individuals aged 15-35 experience the highest frequency of victimization across all crime types. Battery/ simple assault is the most prevalent, even more so among young adults.</p>
<p>Victimization sharply declines after the age of 35, with very few victims over 60. Crimes involving adolescents begin to rise after age 10, peaking in young adulthood. These trends highlight the need for targeted crime prevention measures for younger demographics.</p>
<p><strong>RESEARCH QUESTIONS:</strong></p>
<p><strong>Research Question 1:</strong></p>
<p><strong>What is the relationship between crime types and premises categories, and how are specific crime types distributed across different premises?</strong></p>
<p><img src="images/clipboard-1430531908.png" class="img-fluid"></p>
<p>Fig 6</p>
<p><strong>Why This Question?<br>
</strong> Understanding the relationship between crime types and premises can provide critical insights into which types of crimes are more prevalent in specific locations. This helps law enforcement and policymakers focus on high-risk areas and develop targeted prevention strategies.</p>
<p><strong>Methods:</strong> We used chi-square test and heat map to answer this question. Our findings demonstrates a significant relationship between crime types and premises categories (X² = 16,369, df = 16, p-value &lt; 2.2e-16). The heatmap further illustrates concentrated patterns, suggesting that specific premises types are more vulnerable to particular crimes. These findings underscore the importance of implementing targeted crime prevention strategies in high-risk areas.</p>
<p><strong>Why this method:</strong> The Pearson’s Chi- squared test was chosen as the most appropriate statistical method for this analysis because the research question examines the relationship between two categorical variables: crime type and premises categories. This test is specifically designed to determine whether there is a significant association between such variables by comparing observed frequencies with expected frequencies. Other tests such as t-test or ANOVA, are not suitable because they require continuous dependent variables. Similarly, correlation tests, like Pearson or Spearman are designed for continuous or ordinal variables making them unsuitable here. While we could use logistic regression to explore categorical relationships, it would add unnecessary complexity. Chi-sq test has a non-parametric nature, is flexible in handling multiple categories and is straightforward thus it is the ideal choice for answering the research question and identifying the patterns in the dataset.</p>
<p><strong>Research Question 2:</strong></p>
<p><strong>How does the age distribution of victims differ between severe and non-severe crimes?</strong></p>
<p><img src="images/clipboard-1718982086.png" class="img-fluid"></p>
<p>Fig 7</p>
<p><strong>Why This Question?<br>
</strong> Exploring the age distribution of victims for severe and non-severe crimes is essential to identify which age groups are more vulnerable to severe crimes. This information can guide intervention programs and resource allocation.</p>
<p><strong>Methods:</strong> We used Welch Two-Sample test and box plot. The data includes 248,394 cases of non-sever crimes and 55,806 cases of server crimes. A welch two-sample t-test was conducted to compare the mean victim age between these two categories. The results of the t-test were statistically significant (t = 22.029, df = 89,340, p &lt; 2.2e-16), indicating a significant difference in the mean ages of victims between sever and non-sever crimes. The results suggest that victims of severe crimes are, on average, slightly older than victims of non- severe crimes. While the difference in mean age is statistically significant, the magnitude of the difference is relatively small, which suggests that age may not be the primary factor influencing severity. However, the broader age distribution observed for sever crimes, as visualized (see Fig 7.) indicates greater variability in victim age for these cases.</p>
<p><strong>Why this method:</strong></p>
<p>The t-test was chosen for this analysis because it is well-suited for comparing the means of two independent groups with unequal sample sizes and potentially unequal variances. Since there was a large difference in the sample sizes, this test provided a robust and reliable comparison of mean victim ages with requiring the assumption of equal variances. Additionally, this test directly addresses the research question, focusing on mean differences, and offers interpretable results. Alternative methods, such as non-parametric tests or regression analysis, would be less appropriate as they either do not compare means directly or they go beyond the scope of this specific question.</p>
<p><strong>Research Question 3:</strong></p>
<p>Does the relationship between victim age and total crimes vary by victim sex?</p>
<p><img src="images/clipboard-2613507098.png" class="img-fluid"></p>
<p>Fig 8</p>
<p>First step was to filter and aggregate crime data based on the victim’s sex and age as seen in Fig 8.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-4056037530.png" class="img-fluid figure-img"></p>
<figcaption>Fig 9</figcaption>
</figure>
</div>
<p>The bar chart (Fig 9.) visualizes the distribution of total crime counts by victim sex, expressed as percentages of the total. The data reveals that females victims account for 48.36% of the total crime counts, while male victims make up 51.04%. This shows relatively balanced distribution of crime victims by sex.</p>
<p><strong>Why this:</strong> This research question is a good choice because it addresses critical aspects of victim demographics—age and gender—that are essential for understanding patterns of victimization. By exploring the relationship between victim age and total crime counts across genders, the analysis provides valuable insights into which populations are most vulnerable to criminal activities. These findings can help inform targeted prevention strategies, policy-making, and resource allocation to address the specific needs of high-risk groups, such as younger males and females.</p>
<p><strong>Methods:</strong> We applied regression analysis to evaluate the relationship between total crimes and victim age for males and females. For both the models, the age of the victim is negatively associated with the total number of crimes, indicating that younger victims tend to be involved in more crimes, while older victims are associated with fewer crimes. Specifically, for male victims, each additional year of age is associated with a decrease of approximately 20.6 crimes, while for females the decrease is slightly higher at 24.9 per year. These relationships are statistically significant in both models, with extremely low p-values, suggesting strong evidence against the null hypothesis.</p>
<p>The model for female victims show a stronger relationship, with an R-squared value of 0.2665, compared to 0.1982 for the male model. This suggests that victim age explains a larger portion of the variation in crime totals for female victims than for male victims. The residual standard errors are similar for both models (1186 for males and 1178 for females), indicating similar level of prediction accuracy. Despite the relatively low R-sqed values, which suggest that other factors may influence crime totals beyond age, both models are statistically significant, and victims age is an important predictor of crime involvement for both genders.</p>
<p><strong>Why not another method:</strong> We chose a combination of descriptive (bar chart) and regression analysis to answer this research question because these methods effectively capture both the overall trends and the quantifiable relationship between victim age, gender, and crime counts. Other methods such as t-test or ANOVA, focus on group comparisons and would not capture the continuous relationship between age and crime counts. We did not use machine learning as it prioritizes prediction over interpretability. This was the most suitable choice as it provides clear, statistically significant results that align with the research focus on understanding the relationship rather than making predictio</p>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>